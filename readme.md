# NanaChat - 智能聊天室应用

## 项目简介
NanaChat是一个功能丰富的实时聊天应用，基于WebSocket技术实现即时通信，集成了AI对话、视频播放、天气查询等多种智能功能，提供流畅的用户体验。

## 功能特点

### 1. 实时聊天
- 用户可以设置昵称并登录聊天室
- 支持实时发送和接收消息
- 显示在线用户列表和用户上下线通知

### 2. 特殊功能命令

#### @天气 功能
- 格式：`@天气 城市名称`
- 作用：查询指定城市的实时天气信息
- 输出内容：温度、天气状况、湿度、风力情况、体感温度等
- 自动根据天气状态动态更新聊天背景颜色
- 支持中英文天气状态识别（如Sunny对应晴天、Haze对应霾天等）

#### @电影 功能
- 格式：`@电影 url`
- 作用：解析视频链接并在聊天中嵌入视频播放器
- 播放器大小：400x400像素
- 支持使用`https://jx.m3u8.tv/jiexi/?url=`解析服务

#### @张兵 AI对话功能
- 格式：`@张兵`
- 作用：触发AI回复功能，名为"张兵"的AI会随机回复预设内容
- 支持的回复内容："砰砰砰"、"娜艺那"、"嗨娜娜，你卡了"

#### @音乐 功能
- 格式：`@音乐`
- 作用：快捷输入音乐相关命令
- 支持通过音乐按钮快速触发

### 3. 智能交互功能

#### @提示功能
- 在输入框中输入"@"字符时，自动显示可用功能提示列表
- 支持使用方向键选择提示项
- 按下Tab键可快速确认选择的功能

#### 动态天气背景
- 根据天气功能返回的天气状况，自动改变聊天界面背景颜色
- 支持多种天气类型的背景效果：晴天（橙色）、雨天（蓝色）、雪天（白色）、阴天（灰色）、霾天（淡灰色）等
- 同时支持中文和英文天气状态的识别和背景适配

### 4. 用户限制
- 用户名唯一性检测
- 禁止使用包含"张兵"或"zhangbing"的昵称（不区分大小写），以避免冒充AI

## 技术栈

### 后端
- Python 3.12
- Tornado Web框架
- WebSocket通信
- SQLite数据库（聊天记录存储）
- 多API集成（天气查询）

### 前端
- HTML5
- CSS3
- JavaScript
- WebSocket客户端API
- 动态DOM操作
- 响应式设计

## 安装与启动

### 前置条件
- Python 3.12或更高版本
- pip包管理器

### 安装依赖

```bash
# 安装项目依赖
pip install -r requirements.txt

# 或手动安装主要依赖
pip install tornado requests
```

### 启动服务器

```bash
# 运行服务器
python server.py

# 服务器默认在8888端口启动
# 访问地址: http://localhost:8888
```

## 项目结构

```
NanaChat/
├── .gitignore          # Git忽略文件
├── chat_history.db     # 聊天记录数据库
├── config.json         # 配置文件
├── database.py         # 数据库操作模块
├── index.html          # 主聊天室页面
├── login.html          # 登录页面
├── news_crawler.py     # 新闻爬虫模块
├── pdf_news/           # PDF新闻存储目录
├── readme.md           # 项目说明文档
├── requirements.txt    # 项目依赖列表
├── server.py           # 服务器端主代码
├── static/             # 静态资源文件夹
├── test_user_management.py  # 用户管理测试
├── update_database.py  # 数据库更新脚本
├── user_management.py  # 用户管理模块
└── user_management_readme.md  # 用户管理说明
```

## 主要模块说明

### 1. 服务器核心 (server.py)
- 实现WebSocket服务器
- 处理用户认证、消息广播、特殊命令处理
- 管理在线用户列表
- 集成多种API服务（天气查询）

### 2. 前端界面 (index.html)
- 聊天室主界面
- 实现消息发送和接收界面
- 处理视频播放器嵌入
- 实现动态天气背景功能
- 支持@提示功能的交互逻辑

### 3. 数据库管理 (database.py)
- 管理聊天记录存储
- 提供数据查询和存储接口

### 4. 用户管理 (user_management.py)
- 处理用户注册、登录和验证
- 管理用户信息和权限

## 天气功能API说明

系统使用多个免费天气API作为备选，确保天气查询功能的稳定性：

1. 和风天气API
2. WTTR免费天气API
3. OpenWeatherMap API
4. 详细天气API

当主要API调用失败时，系统会自动尝试其他备选API，并提供IP定位作为最终备用方案。

## 开发指南

### 开发流程

1. **设置开发环境**
   - 安装Python和必要依赖
   - 克隆或下载项目代码

2. **修改服务器端代码**
   - 编辑server.py文件实现新功能
   - 添加新的特殊命令处理逻辑

3. **修改前端界面**
   - 编辑index.html文件更新UI和交互逻辑
   - 添加新功能的前端展示

4. **测试功能**
   - 重启服务器应用更改
   - 访问http://localhost:8888测试功能

### 添加新功能命令

1. 在server.py中的`handle_message`方法中添加新的命令处理逻辑
2. 在index.html中添加相应的前端支持（如需）
3. 更新@提示功能中的命令列表

## 常见问题处理

### 1. 端口占用问题
- 症状：启动服务器时报错"OSError: [WinError 10048] 通常每个套接字地址(协议/网络地址/端口)只允许使用一次"
- 解决方法：
  ```bash
  # 查找占用8888端口的进程
  netstat -ano | findstr :8888
  
  # 终止占用端口的进程
  taskkill /F /PID <进程ID>
  ```

### 2. 用户昵称限制
- 系统不允许使用包含"张兵"或"zhangbing"的昵称
- 尝试使用这些昵称会收到错误提示

### 3. 天气功能响应慢
- 系统会依次尝试多个天气API，可能导致响应时间较长
- 建议检查网络连接或稍后重试

## 发布指南

### 生产环境部署

1. **选择服务器**
   - 推荐使用Linux服务器（如Ubuntu、CentOS）
   - 确保安装Python 3.12+和pip

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **配置防火墙**
   - 开放8888端口
   ```bash
   # Ubuntu示例
   ufw allow 8888
   ```

4. **使用进程管理工具**
   - 推荐使用Supervisor或systemd管理服务
   - 确保服务器重启后自动启动

5. **配置域名（可选）**
   - 设置域名并配置反向代理
   - 推荐使用Nginx作为反向代理服务器

### 安全建议

1. 在生产环境中，建议添加HTTPS支持
2. 增加更严格的用户认证机制
3. 添加消息过滤和内容审核功能
4. 实现用户注册和持久化存储
5. 定期更新API密钥和依赖包

## 许可证

本项目仅供学习和开发使用。

## 联系方式

如有任何问题或建议，请联系项目维护者。