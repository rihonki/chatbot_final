# 用户管理功能说明

## 功能概述

本聊天室项目已实现完整的用户管理功能，包括：

- **用户注册**：创建新用户账号，密码加密存储
- **用户登录**：验证用户身份，登录后设置在线状态
- **用户下线**：安全退出系统，设置离线状态
- **状态查询**：查询指定用户的当前在线状态

## 数据库设计

用户数据表 (`users`) 结构如下：

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 用户唯一ID |
| username | TEXT | NOT NULL UNIQUE | 用户名，唯一且非空 |
| password | TEXT | NOT NULL | 密码哈希值，使用SHA-256加密 |
| online_status | INTEGER | DEFAULT 0 | 在线状态(0=离线, 1=在线) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 注册时间 |
| last_login | TIMESTAMP | - | 最后登录时间 |

## 使用方法

### 1. 数据库初始化

首次使用前，需要更新数据库结构以支持用户管理功能：

```bash
python update_database.py
```

此脚本会为现有的`users`表添加必要的字段，并为现有用户设置默认密码。

### 2. 用户管理系统

运行用户管理界面程序：

```bash
python user_management.py
```

程序提供简单的命令行界面，支持以下操作：

1. **用户注册**：输入用户名和密码创建新账号
2. **用户登录**：验证身份并设置为在线状态
3. **用户下线**：将指定用户设置为离线状态
4. **查询状态**：查看指定用户是否在线
5. **退出系统**：关闭程序

### 3. 功能测试

运行测试脚本验证所有功能是否正常工作：

```bash
python test_user_management.py
```

## 实现细节

### 密码安全

- 使用SHA-256算法对密码进行哈希加密
- 存储加密后的哈希值，不存储明文密码
- 密码验证时对输入密码进行哈希后比对

### 异常处理

- 用户名重复：注册时检查用户名是否已存在
- 密码错误：登录时验证密码是否匹配
- 数据库错误：所有数据库操作都包含try-except块
- 连接错误：关闭程序时正确关闭数据库连接

### 状态管理

- 登录成功后自动设置用户状态为在线
- 下线功能验证用户是否存在且当前在线
- 状态查询返回准确的在线/离线信息

## 依赖说明

- Python 3.x
- SQLite3 (Python标准库)
- hashlib (Python标准库)
- datetime (Python标准库)
- logging (Python标准库)

## 可能出现的异常场景

1. **数据库文件权限问题**：确保程序有读写数据库文件的权限
2. **用户名已存在**：选择其他用户名注册
3. **密码错误**：检查输入的密码是否正确
4. **用户不存在**：确认输入的用户名拼写正确
5. **用户已离线**：尝试下线已离线的用户会失败

## 与聊天室集成

该用户管理功能可以与现有的聊天室系统集成，提供身份认证和状态管理。后续可以：

- 修改服务器端登录逻辑，使用数据库中的用户信息验证
- 实现基于用户身份的访问控制
- 添加用户信息修改功能
- 实现密码重置功能

## 注意事项

- 本实现使用基础的SHA-256哈希，生产环境建议使用更安全的密码哈希库如bcrypt
- 命令行界面仅供演示，可根据需要集成到Web界面
- 请妥善保管数据库文件，防止未授权访问